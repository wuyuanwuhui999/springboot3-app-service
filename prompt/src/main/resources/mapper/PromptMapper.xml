<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.player.prompt.mapper.PromptMapper">

    <insert id="insertPrompt" parameterType="UserPromptEntity">
        INSERT INTO prompt_user (
        id, tenant_id, title, content, disabled,
        categoryId, tags, create_time, update_time, created_by, updated_by
        ) VALUES (
        #{id}, #{tenantId}, #{title}, #{content}, #{disabled},
        #{categoryId}, #{tags}, #{createDate}, #{updateDate}, #{createdBy}, #{updatedBy}
        )
    </insert>

    <delete id="deletePrompt">
        DELETE FROM prompt_user
        WHERE id = #{id} AND tenant_id = #{tenantId} AND created_by = #{createdBy}
    </delete>

    <update id="updatePrompt" parameterType="UserPromptEntity">
        UPDATE prompt_user
        SET title = #{title},
        content = #{content},
        disabled = #{disabled},
        categoryId = #{categoryId},
        tags = #{tags},
        update_date = #{updateDate},
        updated_by = #{updatedBy}
        WHERE id = #{id} AND tenant_id = #{tenantId} AND created_by = #{updatedBy}
    </update>

    <select id="getPromptById" resultType="UserPromptEntity">
        SELECT * FROM prompt_user
        WHERE id = #{id} AND tenant_id = #{tenantId} AND created_by = #{createdBy}
    </select>

    <select id="getPromptList" resultType="UserPromptEntity">
        SELECT * FROM prompt_user
        WHERE tenant_id = #{tenantId} AND created_by = #{createdBy}
        <if test="content != null and content != ''">
            AND content LIKE CONCAT('%', #{content}, '%')
        </if>
        <if test="categoryId != null and categoryId != ''">
            AND categoryId = #{categoryId}
        </if>
        <if test="tags != null and tags != ''">
            AND tags LIKE CONCAT('%', #{tags}, '%')
        </if>
        ORDER BY create_time DESC
    </select>

    <select id="getPromptCategoryList" resultType="PromptCategoryEntity">
        select id,category,create_time,update_time from prompt_category order by update_time desc
    </select>

    <select id="getSystemPromptCountByCategory" resultType="Long">
        select count(*) from prompt_system where disabled=0
        <if test="categoryId != null and categoryId != ''">
            and categoryId = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            and prompt like concat('%',keyword,'%')
        </if>
    </select>

    <select id="getSystemPromptListByCategory" resultType="SystemPromptEntity">
        SELECT
            ps.id,
            ps.categoryId,
            ps.prompt,
            ps.disabled,
            ps.create_time,
            ps.update_time,
            IF(pc.id IS NOT NULL, 1, 0) as is_collect,
            pc.create_time
        FROM
            prompt_system ps
        LEFT JOIN
            prompt_collect pc ON ps.id = pc.prompt_id COLLATE utf8mb4_0900_ai_ci AND pc.user_id = #{userId}
        WHERE
            ps.disabled = 0
        <if test="categoryId != null and categoryId != ''">
            and ps.categoryId = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            and ps.prompt like concat('%',#{keyword},'%')
        </if>
        ORDER BY ps.create_time DESC;
    </select>
</mapper>