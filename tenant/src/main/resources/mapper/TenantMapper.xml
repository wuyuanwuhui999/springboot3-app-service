<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.player.gateway.tenant.mapper.TenantMapper">
    <select id="getUserTenantList" resultType="TenantEntity">
        SELECT * FROM tenant
        WHERE id IN (SELECT tenant_id FROM tenant_user WHERE user_id = #{userId})
        ORDER BY create_date DESC
    </select>

    <!-- 分页查询租户用户（关联用户表查询用户信息） -->
    <select id="getTenantUserList" resultType="TenantUserEntity">
        SELECT
            tu.*,
            u.username,
            u.avater,
            u.email
        FROM tenant_user tu
            LEFT JOIN user u ON tu.user_id = u.id
        WHERE tu.tenant_id = #{tenantId}
            AND EXISTS (
                SELECT 1 FROM tenant_user admin_tu
                WHERE admin_tu.tenant_id = #{tenantId}
                AND admin_tu.user_id = #{userId}
                AND admin_tu.role_type IN (1, 2)  -- 1-租户管理员，2-超级管理员
            )
        ORDER BY tu.join_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 查询租户用户总数 -->
    <select id="getTenantUserListCount" resultType="Long">
        SELECT COUNT(*) FROM tenant_user
        WHERE tenant_id = #{tenantId}
    </select>

    <!-- 查询租户用户总数 -->
    <select id="getTenantUser" resultType="TenantUserEntity">
        SELECT
            tu.*,
            t.name as tenant_name,
            u.username,
            u.avater,
            u.email
        FROM tenant_user tu
                 LEFT JOIN user u ON tu.user_id = u.id COLLATE utf8mb4_unicode_ci
                 LEFT JOIN tenant t ON tu.tenant_id = t.id COLLATE utf8mb4_unicode_ci
        WHERE tu.tenant_id = #{tenantId}
          AND tu.user_id = #{userId}
          AND tu.disabled = 0
    </select>

    <update id="setAdmin">
        UPDATE tenant_user tu
        JOIN tenant_user admin ON admin.tenant_id = #{tenantId}
            AND admin.user_id = #{adminUserId}
            AND admin.role_type = 2
            AND admin.disabled = 0
        SET tu.role_type = #{roleType},
            tu.create_by = #{adminUserId}
        WHERE tu.tenant_id = #{tenantId}
            AND tu.user_id = #{userId}
            AND tu.disabled = 0
    </update>

    <!-- 检查用户是否有管理员权限 -->
    <select id="checkAdminPermission" resultType="int">
        SELECT COUNT(*)
        FROM tenant_user
        WHERE tenant_id = #{tenantId, jdbcType=VARCHAR}
        AND user_id = #{userId, jdbcType=VARCHAR}
        AND role_type IN (1, 2) <!-- 1-租户管理员，2-超级管理员 -->
        AND disabled = 0
    </select>

    <!-- 添加租户用户 -->
    <insert id="addTenantUser" parameterType="map">
        INSERT INTO tenant_user (
            id,
            tenant_id,
            user_id,
            role_type,
            join_date,
            create_by,
            disabled
        ) VALUES (
            #{id},
            #{tenantId},
            #{userId},
            0,
            NOW(),
            #{adminUserId},
            0
        )
    </insert>

    <!-- 删除租户用户 -->
    <delete id="deleteTenantUser" parameterType="map">
        DELETE FROM tenant_user
        WHERE tenant_id = #{tenantId, jdbcType=VARCHAR}
        AND user_id = #{userId, jdbcType=VARCHAR}
    </delete>
</mapper>