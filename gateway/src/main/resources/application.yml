server:
  port: 3009

spring:
  application:
    name: gateway
  main:
    web-application-type: reactive  # 添加这行
  cloud:
    gateway:
      routes:
        - id: movie
          uri: http://localhost:3001
          predicates:
            - Path=/service/movie/**

        - id: music
          uri: http://localhost:3002
          predicates:
            - Path=/service/music/**
          filters:
            - StripPrefix=0

        - id: user
          uri: http://localhost:3005
          predicates:
            - Path=/service/user/**
          filters:
            - StripPrefix=0

        - id: circle
          uri: http://localhost:3004
          predicates:
            - Path=/service/circle/**
          filters:
            - StripPrefix=0

        - id: social
          uri: http://localhost:3003
          predicates:
            - Path=/service/social/**
          filters:
            - StripPrefix=0

        - id: chat
          uri: http://localhost:3006
          predicates:
            - Path=/service/chat/**
          filters:
            - StripPrefix=0

        # WebSocket 路由（需要特殊处理）
        - id: chat_websocket
          uri: ws://localhost:3006
          predicates:
            - Path=/service/chat/ws/**
          filters:
            - StripPrefix=0

        - id: tenant
          uri: http://localhost:3007
          predicates:
            - Path=/service/tenant/**
          filters:
            - StripPrefix=0

        - id: prompt
          uri: http://localhost:3008
          predicates:
            - Path=/service/prompt/**
          filters:
            - StripPrefix=0

        - id: agent
          uri: http://localhost:3010
          predicates:
            - Path=/service/agent/**
          filters:
            - StripPrefix=0

      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials

    compatibility-verifier:
      enabled: false
    nacos:
      # 通用配置
      config:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        # 添加以下认证配置
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:nacos}
        file-extension: yaml
        group: DEFAULT_GROUP
        namespace: public  # 显式指定命名空间
        shared-configs:
          - data-id: common-config.yaml
            group: DEFAULT_GROUP
            refresh: true
        enabled: true
        # 禁用bootstrap检查
        import-check:
          enabled: false

  redis:
    host: localhost
    port: 6379
    password: ""
    database: 0

  datasource:
    url: jdbc:mysql://localhost:3306/play?characterEncoding=utf-8
    username: root
    password: ${MYSQL_PASSWORD}
    driverClassName: com.mysql.jdbc.Driver
    initialSize: 5  #初始建立连接数量
    minIdle: 5  #最小连接数量
    maxActive: 20 #最大连接数量
    maxWait: 10000  #获取连接最大等待时间，毫秒
    testOnBorrow: true #申请连接时检测连接是否有效
    testOnReturn: false #归还连接时检测连接是否有效
    timeBetweenEvictionRunsMillis: 60000 #配置间隔检测连接是否有效的时间（单位是毫秒）
    minEvictableIdleTimeMillis: 300000  #连接在连接池的最小生存时间（毫秒）

jwt:
  secret: ${SECRET}
  expiration: 86400000  # 24小时（毫秒）

management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always

mybatis:
  mapper-locations: classpath:mapper/*Mapper.xml
  type-aliases-package: com.player.gateway.entity
  configuration:
    use-actual-param-name: true
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

logging:
  level:
    reactor.netty.http.client: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.gateway.filter: TRACE
    org.springframework.cloud.gateway.route: TRACE
    com.player.gateway: INFO

gateway:
  log:
    enabled: true
    max-request-body-size: 5000  # 最大请求体记录大小
    max-response-body-size: 5000  # 最大响应体记录大小
    sensitive-paths:
      - /service/user/login
      - /service/user/loginByEmail
      - /service/user/register
